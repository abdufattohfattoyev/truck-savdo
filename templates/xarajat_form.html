<div class="form-container p-4">
    <form id="xarajatForm" method="POST" action="{% if action == 'add' %}{% url 'xarajat_add' %}{% else %}{% url 'xarajat_edit' xarajat_id %}{% endif %}" class="ajax-form">
        {% csrf_token %}
        <div class="mb-3">
            <label for="id_truck" class="form-label">{{ form.truck.label }}</label>
            {{ form.truck }}
            <div id="truck-error" class="invalid-feedback"></div>
        </div>
        <div class="mb-3">
            <label for="id_xarajat_turi" class="form-label">{{ form.xarajat_turi.label }}</label>
            {{ form.xarajat_turi }}
            <div id="xarajat_turi-error" class="invalid-feedback"></div>
        </div>
        <div class="mb-3">
            <label for="id_miqdor" class="form-label">{{ form.miqdor.label }}</label>
            {{ form.miqdor }}
            <div id="miqdor-error" class="invalid-feedback"></div>
        </div>
        <div class="mb-3">
            <label for="id_sana" class="form-label">{{ form.sana.label }}</label>
            {{ form.sana }}
            <div id="sana-error" class="invalid-feedback"></div>
        </div>
        <div class="mb-3">
            <label for="id_izoh" class="form-label">{{ form.izoh.label }}</label>
            {{ form.izoh }}
            <div id="izoh-error" class="invalid-feedback"></div>
        </div>
        <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" onclick="closeFormSidebar()">Bekor qilish</button>
            <button type="submit" class="btn btn-primary">Saqlash</button>
        </div>
    </form>
</div>

<script>
document.getElementById('xarajatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = this;
    const formData = new FormData(form);

    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            closeFormSidebar();
            // Sahifani qayta yuklamaslik uchun refreshData ni ishlatamiz
            setTimeout(() => window.refreshData(), 1000); // Jadvalni yangilash
        } else {
            if (data.errors) {
                resetFormErrors(form);
                showFormErrors(form, data.errors);
            } else {
                showAlert('error', data.message || 'Forma yuborishda xatolik yuz berdi!');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Server bilan bog‘lanishda xatolik yuz berdi!');
    });
});

// Qo‘shimcha foydali funksiyalar (agar mavjud bo‘lmasa)
function resetFormErrors(form) {
    const fields = form.querySelectorAll('.is-invalid');
    fields.forEach(field => field.classList.remove('is-invalid'));
    const feedbacks = form.querySelectorAll('.invalid-feedback');
    feedbacks.forEach(feedback => feedback.innerHTML = '');
}

function showFormErrors(form, errors) {
    Object.keys(errors).forEach(key => {
        const field = form.querySelector(`[name="${key}"]`);
        if (field) {
            field.classList.add('is-invalid');
            const feedback = field.nextElementSibling || document.createElement('div');
            feedback.className = 'invalid-feedback';
            feedback.textContent = errors[key];
            field.parentNode.appendChild(feedback);
        }
    });
}

// getCookie funksiyasi (agar avval kiritilmagan bo‘lsa)
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : null;
}
</script>